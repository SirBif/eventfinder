<!doctype html>
<head>
  <meta charset="utf-8">

  <title>Eventi</title>
  <meta name="description" content="Event Finder">
  <meta name="viewport" content="width=device-width">
  <script type="text/javascript" src="//raw.github.com/timrwood/moment/2.0.0/min/moment.min.js"></script>
</head>
<body>
<style type="text/css">
    html,body {
		height: 100%
	}
	#mapContainer
    {
		height: 100%;		
    }
    #mapC {
        height: 100%;
        width: 80%;
        float: left;
    }
    #listContainer{
        height: 100%;
        width: 20%;
        float: left;
        overflow-y: auto;
        
    }
    #resultTable{
        height: 100%;
    }
    li {
        font-size: small;
    }    
    #fbButton{
        float: left;
    }
    .hide {
        display: none;
    }
   .highlighted{
        font-size: large;
   }
    </style>
<div id="fb-root"></div>
<script>
	window.fbAsyncInit = function() {		
		FB.init({
			appId      : <%= process.env.FACEBOOK_APP_ID %>, // Facebook App ID
			cookie     : true, // enable cookies to allow Parse to access the session
			xfbml      : true  // parse XFBML
		});

		FB.Event.subscribe('auth.authResponseChange', function(response) {
			// Here we specify what we do with the response anytime this event occurs. 
			if (response.status === 'connected') {
				$('#fbButton').addClass('hide');
				handleLogin();
			} else if (response.status === 'not_authorized') {
			    $('#fbButton').removeClass('hide');
				FB.login();
			} else {
			    $('#fbButton').removeClass('hide');
				FB.login();
			}
		});
	};

	// Load the SDK asynchronously
	(function(d){
		var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
		if (d.getElementById(id)) {return;}
		js = d.createElement('script'); js.id = id; js.async = true;
		js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=" + <%= process.env.FACEBOOK_APP_ID %>;
		ref.parentNode.insertBefore(js, ref);
	}(document));
	
	function updateMarkers() {
	    var properties = $('#mapContainer').jHERE();
        var bottomRight = properties.bbox.bottomRight;
        var topLeft = properties.bbox.topLeft;
        $('#mapContainer').jHERE('nomarkers');
        $('#list').empty();
        var requestString = "/retrieve?";
        requestString += "bottomRightLat=" + bottomRight.latitude;
        requestString += "&bottomRightLon=" + bottomRight.longitude;
        requestString += "&topLeftLat=" + topLeft.latitude;
        requestString += "&topLeftLon=" + topLeft.longitude;
        $.get(requestString, {}).then(function(resultsJson) {printResults(resultsJson);});
	}
	
	function handleLogin() {
		FB.getLoginStatus(function(response) {
			if (response.status === 'connected') {
				var uid = response.authResponse.userID;
				var accessToken = response.authResponse.accessToken;
				$.jHERE.defaultCredentials('2555Yk0ixeYKXQe2OrXM', 'E5I47YZhcJA7W9P6eIebEA');
			    $('#mapContainer').jHERE({
                    enable: ['behavior', 'positioning'],
                    center: [44.843699,11.619072],
                    zoom: 9
                });
                $('#mapContainer').on('mapdragend', function(e) {updateMarkers();});
                $('#mapContainer').on('mapresize', function(e) {updateMarkers();});
                $('#mapContainer').on('maptouchend', function(e) {updateMarkers();});
                $('#mapContainer').jHERE('originalMap', function(map, here) {
	                map.addObserver("zoomLevel", function (obj, key, newValue, oldValue) {
	                    console.log("//Was: " + oldValue);
	                    console.log("observation: " + obj.$name + "[" + key + "] = " + newValue + ";");
                    });
                });
                
				$.get("/login", {uid: uid, token : accessToken});
				$.get("/update", {});
			}
		});
	}

	function printResults(results) {
		if(results == undefined) {			
            // stuff
		} else {
          var i = 1;
			results.forEach(function(entry) {			 	
				$('#mapContainer').jHERE('marker', [parseFloat(entry.latitude), parseFloat(entry.longitude)], {
                	text: i,
                	click: function(event) {
                	    window.open("http://www.facebook.com/" + entry.eid,'_blank');
                	},
                	click: function(event) {
                	    window.open("http://www.facebook.com/" + entry.eid,'_blank');
                	}
                });
                $('#list').append('<li id="item_' +i+ '"><a href="http://www.facebook.com/' + entry.eid +'" target="_blank">' + entry.name + '</a>\n(Going: ' + entry.people + ')</li>');
                i++;
            });
		}
	}
</script>
<!--Below we include the Login Button social plugin. This button uses the JavaScript SDK to-->
<!--present a graphical Login button that triggers the FB.login() function when clicked.-->
<div id="fbButton">
    <fb:login-button show-faces="true" width="200" max-rows="1"></fb:login-button>
</div>
<div id="resultTable">
    <div id="listContainer">
        <ol id="list"></ol>
    </div>
    <div id="mapC">
        <div id="mapContainer"></div>
    </div>
</div>
<script src="//code.jquery.com/jquery-1.9.1.min.js"></script>
<script src="js/jhere.min.js"></script>
</body>
</html>
